<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8' />
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
        <link href="{{ url_for('static', filename='styles/calendar_page.css')}}" rel="stylesheet" />
        <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>
        <title>Events</title>
    </head>
    <body>
        {% include '/components/nav.html' %}
        <div class="calendar-page">
            {% include '/components/calendar_page/sidebar.html' %}
            <div id='calendar'></div>
        </div>
        <script>
            const fetchEvents = async () => {
                const eventRes = await fetch('/api/events');
                const { events } = await eventRes.json();

                const clubRes = await fetch('/api/clubs');
                const clubs = (await clubRes.json()).clubs.map(clubEntry => {
                    return clubEntry[1];
                });

                const selectedClubs = clubs.filter(club => {
                    const toggle = document.querySelector(`#${club}`);
                    return toggle && toggle.checked;
                });

                return events.filter(event => selectedClubs.includes(event[2])).map(event => {
                    const eventName = event[1];
                    const clubName = event[2];
                    const startTime = event[4];
                    const endTime = event[5];

                    return {
                        title: `${event[2]} - ${event[1]} - ${event[3]}`,
                        club: event[2],
                        start: event[4],
                        end: event[5],
                        color: color(event[2])
                    };
                });
            };

            function color(clubname) {
                if (clubname === "Cannon Club")
                    return '#C8E117'
                if (clubname === "Cap & Gown")
                    return '#E13917'
                if (clubname === "Charter Club")
                    return '#E18217'
                if (clubname === "Cloister Inn")
                    return '#1751E1'
                if (clubname === "Colonial Club")
                    return '#E117A4'
                if (clubname === "Cottage Club")
                    return '#000000'
                if (clubname === "Ivy Club")
                    return '#007620'
                if (clubname === "Quadrangle Club")
                    return '#734400'
                if (clubname === "Terrace F. Club")
                    return '#6E13B9'
                if (clubname === "Tiger Inn")
                    return '#378006'
                if (clubname === "Tower Club")
                    return '#5E6600'
            };

            let view = 'dayGridMonth';
            const renderCalendar = async () => {
                const events = await fetchEvents();

                var calendarEl = document.getElementById('calendar');

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: view,
                    initialDate: new Date().toISOString().slice(0, 10),
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    datesSet: (dateInfo) => {
                        view = dateInfo.view.type;
                    },
                    events: events,
                });

                calendar.render();
            };

            document.addEventListener('DOMContentLoaded', renderCalendar);

            document.querySelectorAll('.checkbox').forEach(input => {
                input.onchange = async () => {
                    await renderCalendar();
                };
            })
        </script>
    </body>
</html>
